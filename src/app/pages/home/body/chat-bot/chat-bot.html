<div class="chat-container" [class.open]="isOpen()">
  <div class="chat-header">
    <h3>Travel Assistant</h3>
    <div class="header-actions">
      <button class="icon-btn" (click)="clearHistory()" [disabled]="isLoading()">
        <span class="icon">🗑️</span>
      </button>
      <button class="icon-btn" (click)="toggleChat()">
        <span class="icon">✕</span>
      </button>
    </div>
  </div>

  @if (isOpen()) {
    <div class="chat-body">
      @if (isLoading() && messages().length === 0) {
        <div class="loading-full">
          <div class="spinner"></div>
          <div>Loading your chat history...</div>
        </div>
      }
      @else if (errorLoadingHistory()) {
        <div class="error-message">
          Failed to load chat history. 
          <button class="retry-btn" (click)="loadChatHistory()">Retry</button>
        </div>
      }
      @else {
        @for (message of messages(); track $index) {
          <div class="message" [class.user]="message.from === 'user'" [class.bot]="message.from === 'bot'">
            <div class="message-content">{{ message.text }}</div>
            <div class="message-time">{{ message.timestamp | date:'shortTime' }}</div>
          </div>
        }
      }
      
      @if (isLoading() && messages().length > 0) {
        <div class="loading-partial">
          <div class="spinner"></div>
        </div>
      }
    </div>

    <div class="chat-footer">
      <div class="message-input">
        <input 
          [(ngModel)]="userInput" 
          placeholder="Type your message..." 
          (keyup.enter)="sendMessage()"
          [disabled]="isLoading()"
        />
      </div>
      <button class="send-btn" (click)="sendMessage()" [disabled]="!userInput() || isLoading()">
        Send
      </button>
    </div>
  }
</div>

@if (!isOpen()) {
  <button class="floating-btn" (click)="toggleChat()">
    <i class="fas fa-comment-dots"></i>
  </button>
}